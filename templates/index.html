<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifePlants: Zen Monitor</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body class="weather-{{ weather.weather[0].main.lower() if weather else 'clear' }}">

    <main class="dashboard-container">
        
        <div class="glass-card weather-section {% if temp > 30 %}heat-alert{% endif %}">
            <hgroup>
                <h1>LifePlants Eco-Sync</h1>
                <h3>Digital Twin Garden</h3>
            </hgroup>
            
            <form action="/" method="get" class="city-search">
                <input id="cityInput" type="text" name="city" placeholder="Search location..." value="{{ current_city }}" required>
                <button type="submit">Sync üåè</button>
                <button type="button" id="pickOnMapBtn" class="outline">Pick on map üó∫Ô∏è</button>
            </form>
            
            <div class="grid" style="margin-top: 20px;">
                <div>
                    <h2 style="font-size: 3rem; margin:0;">{{ temp }}¬∞C</h2>
                    <small>in {{ weather.name if weather else current_city }}</small>
                </div>
                <div>
                    <h2 style="font-size: 3rem;">{% if temp > 30 %}‚òÄÔ∏è{% elif temp < 15 %}‚ùÑÔ∏è{% else %}‚õÖ{% endif %}</h2>
                    <small>{{ weather.weather[0].main if weather else 'Offline' }}</small>
                </div>
            </div>

            {% if temp > 30 %}
            <div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 15px; margin-top: 20px; font-weight: bold;">
                üî• <strong>Heat Alert:</strong> Evaporation x2.5 active.
            </div>
            {% endif %}
        </div>

        <details style="margin-bottom: 30px;">
            <summary role="button" class="outline contrast" style="border-radius: 50px; border-color: #2d6a4f; color: #2d6a4f;">
                + Plant a New Seed
            </summary>
            <div class="glass-card" style="margin-top: 20px;">
                <form action="/add" method="post">
                    
                    <label>Nickname</label>
                    <input type="text" name="name" placeholder="e.g., Zen Master" required>
                    
                    <label>Specie</label>
                    <input type="text" name="species" placeholder="e.g., Bamboo" required>
                    
                    <label>Type</label>
                    <select name="type" required style="border-radius: 20px; border: 1px solid #dcdcdc; padding: 10px;">
                        <option value="" disabled selected>Select a type...</option>
                        <option value="Tree">Tree</option>
                        <option value="Shrub">Shrub</option>
                        <option value="Herbaceous">Herbaceous</option>
                        <option value="Flower">Flower</option>
                        <option value="Vine">Vine</option>
                        <option value="Groundcover">Groundcover</option>
                        <option value="Succulent">Succulent</option>
                        <option value="Cactus">Cactus</option>
                        <option value="Aquatic">Aquatic</option>
                        <option value="Epiphyte">Epiphyte</option>
                    </select>

                    <button type="submit" style="background: #2d6a4f; border: none; border-radius: 50px; margin-top: 15px; width: 100%;">Grow üå±</button>
                </form>
            </div>
        </details>

        <div class="plant-collection">
            {% for plant in plants %}
            <div class="plant-card">
                <div class="glass-card status-{{ plant.status }}" 
                     data-advice="{{ plant.advice }}"
                     onmouseenter="updateAI(this.dataset.advice)" 
                     onmouseleave="resetAI()">
                    
                    <div class="grid">
                        <div>
                            <strong style="font-size: 1.4rem;">{{ plant.name }}</strong>
                            <br><small style="color: #666; font-style: italic;">{{ plant.species }}</small>
                        </div>
                        <div style="text-align: right;">
                            <span class="status-badge" style="background: #eee; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                                {{ plant.status|upper }}
                            </span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <svg class="plant-svg" viewBox="0 0 100 100" aria-hidden="true">
                            <path fill="#795548" d="M25,75 L75,75 L70,95 L30,95 Z" />
                            <rect x="25" y="70" width="50" height="5" fill="#5d4037" rx="2" />
                            {% if plant.type == 'Cactus' %}
                            <g class="plant-path">
                                <path d="M50 70 Q50 50 50 30" stroke="currentColor" stroke-width="5" fill="none" stroke-linecap="round" />
                                <path d="M40 60 Q35 48 40 38" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round" />
                                <path d="M60 60 Q65 48 60 38" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round" />
                                <circle cx="50" cy="27" r="6" fill="currentColor" />
                            </g>
                            {% elif plant.type == 'Tree' %}
                            <g class="plant-path">
                                <rect x="46" y="45" width="8" height="25" rx="3" fill="currentColor"></rect>
                                <circle cx="40" cy="45" r="14"></circle>
                                <circle cx="58" cy="42" r="12"></circle>
                                <circle cx="48" cy="32" r="10"></circle>
                            </g>
                            {% elif plant.type == 'Vine' %}
                            <g class="plant-path">
                                <path d="M38 70 C35 55 48 48 52 40 C56 32 44 28 46 22" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"/>
                                <path d="M62 70 C59 55 72 50 70 42 C68 34 58 30 60 22" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"/>
                                <circle cx="44" cy="30" r="4"></circle>
                                <circle cx="66" cy="34" r="4"></circle>
                            </g>
                            {% else %}
                            <g class="plant-path">
                                <path d="M50,70 Q50,45 50,25" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round" />
                                <ellipse cx="30" cy="35" rx="20" ry="10" transform="rotate(-30 30 35)" />
                                <ellipse cx="70" cy="35" rx="20" ry="10" transform="rotate(30 70 35)" />
                                <circle cx="50" cy="20" r="7" fill="#ffeb3b" stroke="orange" stroke-width="1" />
                            </g>
                            {% endif %}
                        </svg>
                    </div>
                    
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        <small>Hydration</small>
                        <small><strong>{{ plant.humidity }}%</strong></small>
                    </label>
                    <progress value="{{ plant.humidity }}" max="100" class="{{ plant.status }}"></progress>
                    
                    <div class="actions">
                        <a href="/water/{{ plant.id }}" role="button" class="btn-ghost">
                            üíß Water Plant
                        </a>
                        <a href="/delete/{{ plant.id }}" role="button" class="btn-ghost btn-danger" onclick="return confirm('Delete this plant?');">
                            üóëÔ∏è Delete
                        </a>
                    </div>
                </div>
            </div>
            {% else %}
            <div style="text-align: center; color: #888; padding: 60px;">
                <h2>üçÇ The garden is quiet.</h2>
                <p>Plant a seed to begin your journey.</p>
            </div>
            {% endfor %}
        </div>

        <div class="music-widget">
            <button id="musicBtn">üéµ Play Zen Music</button>
        </div>

        <div class="ai-companion-widget" id="aiWidget">
            <div class="ai-avatar">ü§ñ</div>
            <div id="aiText">I‚Äôm watching your plants. Always watching.</div>
        </div>

    </main>

    <!-- Modal de mapa -->
    <div class="map-modal-backdrop" id="mapModal">
        <div class="map-modal">
            <header>
                <h3>Pick on map</h3>
                <button class="map-close-btn" id="closeMapModal" aria-label="Close map modal">‚úï</button>
            </header>
            <div class="map-body">
                <div id="mapPicker"></div>
            </div>
            <div class="map-hint">
                Click on the map to set your city. We‚Äôll reverse-geocode with Nominatim (OSM) and fill the city field automatically.
            </div>
        </div>
    </div>

    <script>
        // Control de visibilidad y texto del Widget de IA
        const widgetText = document.getElementById('aiText');
        
        function updateAI(advice) {
            if (!advice) return;
            widgetText.style.opacity = 0;
            setTimeout(() => {
                widgetText.innerText = advice;
                widgetText.style.opacity = 1;
            }, 200);
        }

        function resetAI() {
            widgetText.style.opacity = 1;
        }
    </script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='js/map_picker.js') }}"></script>
    <script src="{{ url_for('static', filename='js/zen_audio.js') }}"></script>
</body>
</html>